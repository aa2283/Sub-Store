name: Sub-Store Sync (File Mode)

on:
  workflow_dispatch: # 支持手动运行
  push:
    paths:
      - 'sub-store-data/sub-store.json' # 当你修改了 JSON 文件时自动触发转换
  schedule:
    - cron: '0 22 * * *' # 每天北京时间早晨 6 点自动更新

jobs:
  sync:
    runs-on: ubuntu-latest
    # 给权限以便自动 git push 结果
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Sub-Store (via API)
        run: |
          mkdir -p output
          # 1. 后台启动 Sub-Store (不加 sync，让它正常启动)
          # 使用 --data-directory 确保它能读到根目录的配置
          cp sub-store-data/sub-store.json ./sub-store.json
          
          echo ">>> 正在后台启动服务端..."
          SUB_STORE_DATA_DIRECTORY=$(pwd) node ./sub-store.bundle.js &
          
          # 2. 等待服务端就绪 (等待 10 秒)
          sleep 10
          
          echo ">>> 正在通过 API 触发同步..."
          # 调用内部同步 API，强制存盘
          curl -X POST "http://127.0.0.1:3000/api/sync" || echo "API 触发失败，尝试备用方案"
          
          # 3. 给一点点时间让它写文件
          sleep 5
          
          echo ">>> 检查生成情况:"
          ls -la output/ || echo "Output 文件夹依然为空"
          
          # 4. 杀死后台进程，准备上传
          pkill -f node || true
          
          

      - name: Git Push Results
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add output/*.yaml output/*.txt || true # 假设你生成的是这些格式
          git commit -m "Auto sync subscriptions: $(date '+%Y-%m-%d %H:%M:%S')" || exit 0
          git push
