name: Sub-Store Sync (File Mode)

on:
  workflow_dispatch: # 支持手动运行
  push:
    paths:
      - 'sub-store-data/sub-store.json' # 当你修改了 JSON 文件时自动触发转换
  schedule:
    - cron: '0 22 * * *' # 每天北京时间早晨 6 点自动更新

jobs:
  sync:
    runs-on: ubuntu-latest
    # 给权限以便自动 git push 结果
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Sub-Store (Force Sync via API)
        run: |
          mkdir -p output
          
          # 1. 生成正确的配置文件
          cat <<EOF > ./sub-store-data/sub-store.json
          {
            "subs": [{
              "name": "MyNodes",
              "type": "http",
              "url": "https://cw.itao.qzz.io/e2c06fc8-29a8-44ca-b405-2349eab7b7df/sub"
            }],
            "targets": [{
              "type": "clash",
              "filename": "config.yaml",
              "payload": { "subs": ["MyNodes"], "options": { "gen-config": true } }
            }]
          }
          EOF

          # 2. 启动容器
          docker run -d --name substore-svc \
            -p 3001:3001 \
            -v ${{ github.workspace }}/sub-store-data:/opt/app/data \
            -e SUB_STORE_DATA_DIRECTORY=/opt/app/data \
            xream/sub-store
          
          echo ">>> 等待服务启动..."
          sleep 10
          
          # 3. 【关键：踢它一脚】通过 API 强制触发所有 Target 同步
          echo ">>> 正在发送同步指令..."
          docker exec substore-svc curl -s http://127.0.0.1:3001/api/syncArtifacts
          
          echo ">>> 等待处理 (10秒)..."
          sleep 10
          
          # 4. 打印日志看它干活没
          docker logs substore-svc
          
          # 5. 提取文件
          docker cp substore-svc:/opt/app/data/. ${{ github.workspace }}/output/
          docker stop substore-svc && docker rm substore-svc
          
          echo ">>> 检查结果:"
          ls -R output/
          
          

      - name: Push to Another Repo
        env:
          TARGET_REPO: "aa2283/v2ray_configs"
        run: |
          # 1. 使用 PAT 鉴权并克隆目标仓库到 tmp_repo 文件夹
          git clone "https://x-access-token:${{ secrets.MY_PAT }}@github.com/${{ env.TARGET_REPO }}.git" tmp_repo
          
          # 2. 确保目标仓库有 output 目录
          mkdir -p tmp_repo/output
          
          # 3. 将本次生成的所有文件拷贝到目标仓库的 output 目录下
          # 使用 -f 强制覆盖，如果没有文件则打印警告
          cp -rf output/* tmp_repo/output/ || echo "Warning: No files found to copy"
          
          # 4. 进入目标仓库执行提交
          cd tmp_repo
          git config user.email "actions@github.com"
          git config user.name "Sub-Store Bot"
          
          # 添加所有更改
          git add .
          
          # 检查是否有内容变更，避免空提交报错
          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "Auto Update Subscriptions: $(date +'%Y-%m-%d %H:%M')"
            git push origin main # 如果目标仓库主分支是 master，请改为 master
          else
            echo "No changes detected, skipping push."
          fi
