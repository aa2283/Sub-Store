name: Long-Time Debugger

on:
  workflow_dispatch: # 手动触发

jobs:
  debug-session:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Launch Sub-Store
        run: |
          # 启动容器并映射 3001 前端端口
          docker run -d --name substore-svc \
            -p 3001:3001 \
            xream/sub-store
          
          echo "等待容器初始化..."
          sleep 5

      - name: Setup Cloudflare Quick Tunnel
        run: |
          # 下载 Cloudflared
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared

          # 启动隧道映射到 3001 端口，日志输出到 tunnel.log
          # 不使用 Token，直接创建快速隧道
          ./cloudflared tunnel --url http://127.0.0.1:3001 --logfile tunnel.log &
          
          # 循环检查日志，直到域名生成
          echo "等待 Cloudflare 生成公网域名..."
          ITER=0
          while [ $ITER -lt 10 ]; do
            TUNNEL_URL=$(grep -o 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
            if [ -n "$TUNNEL_URL" ]; then
              echo "========================================================="
              echo "✅ 你的 Sub-Store 已经成功发射到公网！"
              echo "🔗 访问地址: $TUNNEL_URL"
              echo "========================================================="
              break
            fi
            sleep 2
            ITER=$((ITER+1))
          done

      - name: Keep Alive for Debugging
        run: |
          # 保持运行 1 小时 (3600秒)
          # 你可以随时在 GitHub 页面点击 "Cancel workflow" 来提前关闭
          echo ">>> 调试窗口已开启 (有效期 60 分钟) <<<"
          echo "你可以现在点击上面的链接进入界面操作。"
          echo "注意：虚拟机销毁后，所有未保存到 sub-store.json 的更改都会丢失。"
          
          sleep 3600
