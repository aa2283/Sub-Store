name: Sub-Store Container Network Debugger

on:
  workflow_dispatch: # 手动点击 Actions 运行

jobs:
  network-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Run Sub-Store and Test IP
        run: |
          # 1. 启动容器（后台运行）
          echo ">>> 正在启动 Sub-Store 容器..."
          docker run -d --name substore-test \
            -p 3000:3000 \
            -p 3001:3001 \
            xream/sub-store
          
          # 等待容器完全启动
          sleep 10
          
          # 2. 获取并显示内网 IP
          CONTAINER_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' substore-test)
          echo "=========================================="
          echo "✅ 容器内网 IP 为: $CONTAINER_IP"
          echo "=========================================="
          
          # 3. 测试本地回环与内网 IP 连通性
          echo ">>> 测试容器内网端口连通性..."
          curl -I -m 5 http://127.0.0.1:3000/api/version || echo "❌ 127.0.0.1 访问失败"
          curl -I -m 5 http://$CONTAINER_IP:3000/api/version || echo "❌ 容器 IP 访问失败"
          
          # 4. 【核心测试】测试 GitHub 运行环境能否连接你的机场订阅
          echo ">>> 测试 GitHub 服务器到机场链接的连通性..."
          # 这里会自动测试你之前提供的链接
          curl -I -L -m 15 "https://cw.itao.qzz.io/e2c06fc8-29a8-44ca-b405-2349eab7b7df/sub" \
            -H "User-Agent: Clash" || echo "❌ 无法连接到机场订阅链接 (可能是 GitHub IP 被封锁)"
          
          # 5. 查看容器内部运行日志
          echo ">>> 正在打印容器实时日志..."
          docker logs substore-test
          
          # 6. 停止并清理
          docker stop substore-test && docker rm substore-test
          echo ">>> 测试完成。"
