name: Sub-Store Full Stack Debugger

on:
  workflow_dispatch:

jobs:
  debug-session:
    runs-on: ubuntu-latest
    steps:
      - name: Launch Sub-Store
        run: |
          # å¯åŠ¨å®¹å™¨
          # æˆ‘ä»¬æŠŠå‰ç«¯å’Œåç«¯ç«¯å£éƒ½æ˜ å°„å‡ºæ¥
          docker run -d --name substore-svc \
            -p 3000:3000 \
            -p 3001:3001 \
            xream/sub-store
          sleep 5

      - name: Setup Cloudflare Double Tunnel
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared

          # åˆ›å»ºé…ç½®æ–‡ä»¶æ¥åŒæ—¶æ˜ å°„ä¸¤ä¸ªç«¯å£
          cat <<EOF > config.yml
          tunnel: debug-tunnel
          credentials-file: /home/runner/.cloudflared/debug.json
          ingress:
            - hostname: substore-api.trycloudflare.com
              service: http://localhost:3000
            - hostname: substore-ui.trycloudflare.com
              service: http://localhost:3001
            - service: http_status:404
          EOF

          # å…¶å® Quick Tunnel æœ‰ä¸ªæ›´ç®€å•çš„é»‘ç§‘æŠ€ï¼š
          # æˆ‘ä»¬ç›´æ¥æŠŠæ•´ä¸ª 3001 ç«¯å£å‘å‡ºå»ï¼Œ
          # ç„¶ååœ¨ç½‘é¡µé‡Œæ‰‹åŠ¨ä¿®æ”¹åç«¯åœ°å€ã€‚
          
          ./cloudflared tunnel --url http://127.0.0.1:3001 --logfile tunnel.log &
          
          sleep 10
          TUNNEL_URL=$(grep -o 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
          
          echo "========================================================="
          echo "ğŸš€ ç¬¬ä¸€æ­¥ï¼šè®¿é—®å‰ç«¯å…¥å£ï¼š"
          echo "$TUNNEL_URL"
          echo ""
          echo "ğŸš€ ç¬¬äºŒæ­¥ï¼šç”±äºåç«¯(3000)æ²¡åœ¨åŒä¸€ä¸ªåŸŸåï¼Œè¯·è¿›å…¥ç½‘é¡µåï¼š"
          echo "1. ç‚¹å‡»å³ä¸Šè§’çš„ã€è®¾ç½®ã€(é½¿è½®å›¾æ ‡)"
          echo "2. åœ¨ã€åç«¯åœ°å€ã€é‡Œå¡«å…¥è¿™ä¸ªï¼ˆæˆ–è€…æ˜¯è®©å®ƒä¿æŒé»˜è®¤ä½†è¦ç¡®ä¿è¿é€šæ€§ï¼‰"
          echo "   ç”±äº Quick Tunnel é™åˆ¶ï¼Œæœ€ç¨³å¦¥çš„åŠæ³•æ˜¯ï¼šå†å¼€ä¸€ä¸ªéš§é“ç»™ 3000"
          echo "========================================================="

      - name: Launch Backend Tunnel (Key!)
        run: |
          # ä¸º 3000 ç«¯å£å†å¼€ä¸€ä¸ªç‹¬ç«‹éš§é“
          ./cloudflared tunnel --url http://127.0.0.1:3000 --logfile backend.log &
          sleep 10
          BACKEND_URL=$(grep -o 'https://[-0-9a-z]*\.trycloudflare\.com' backend.log | head -n 1)
          echo "========================================================="
          echo "ğŸ”— ä½ çš„ä¸“å±åç«¯åœ°å€ (API) æ˜¯ï¼š"
          echo "$BACKEND_URL"
          echo "========================================================="
          echo "ğŸ‘‰ è¯·åœ¨æ‰“å¼€çš„å‰ç«¯ç½‘é¡µé‡Œï¼ŒæŠŠè®¾ç½®ä¸­çš„åç«¯åœ°å€æ”¹ä¸ºä¸Šé¢è¿™ä¸ª URLï¼"
          echo "========================================================="
          
          sleep 3600

          - name: Download and Save Subscriptions
          run: |
          # 1. ç­‰å¾… Sub-Store å®¹å™¨å®Œå…¨å¯åŠ¨å¹¶åŒæ­¥å®Œæˆ
          echo "ç­‰å¾…å®¹å™¨å°±ç»ª..."
          sleep 15
          
          # 2. åˆ›å»º subs ç›®å½•
          mkdir -p subs
          
          echo ">>> æ­£åœ¨æŠ“å– ClashMeta æ ¼å¼é…ç½®..."
          # ä¸‹è½½ target=ClashMeta å¹¶ä¿å­˜åˆ° subs/all.yaml
          curl -s "http://127.0.0.1:3001/download/sub?target=ClashMeta" -o Subs/all.yaml
          
          echo ">>> æ­£åœ¨æŠ“å– URI æ ¼å¼é…ç½®..."
          # ä¸‹è½½ target=URI å¹¶ä¿å­˜åˆ° subs/all.txt
          curl -s "http://127.0.0.1:3001/download/sub?target=URI" -o Subs/all.txt
          
          # 3. æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼Œç¡®ä¿ä¸æ˜¯ç©ºæ–‡ä»¶
          ls -lh subs/
          
      - name: Git Push Changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add Subs/
          # åªæœ‰åœ¨æœ‰å˜åŠ¨æ—¶æ‰æäº¤ï¼Œé˜²æ­¢æŠ¥é”™
          git commit -m "è‡ªåŠ¨æ›´æ–°è®¢é˜…: $(date +'%Y-%m-%d %H:%M')" || exit 0
          git push
