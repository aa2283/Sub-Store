name: Sub-Store è‡ªåŠ¨åŒæ­¥ä¸è°ƒè¯•

on:
  workflow_dispatch:

jobs:
  build-and-debug:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          # å…³é”®ï¼šåœ¨è¿™é‡Œå°±ç»‘å®šä½ çš„ PATï¼Œåç»­ push å°±ä¸ä¼šæŠ¥ 403 äº†
          token: ${{ secrets.MY_PAT }}

      - name: 2. å¯åŠ¨ Sub-Store æœåŠ¡
        run: |
          docker run -d --name substore-svc \
            -p 3000:3000 \
            -p 3001:3001 \
            xream/sub-store
          echo "ç­‰å¾…å®¹å™¨åˆå§‹åŒ– (20ç§’)..."
          sleep 20

      - name: 3. æŠ“å–è®¢é˜…å†…å®¹
        run: |
          mkdir -p subs
          echo ">>> æ­£åœ¨æŠ“å– ClashMeta æ ¼å¼..."
          curl -s "http://127.0.0.1:3000/download/sub?target=ClashMeta" -o subs/all.yaml
          echo ">>> æ­£åœ¨æŠ“å– URI æ ¼å¼..."
          curl -s "http://127.0.0.1:3000/download/sub?target=URI" -o subs/all.txt
          ls -lh subs/

      - name: 4. æ¨é€æ›´æ–°åˆ° GitHub ä»“åº“
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          
          git add subs/
          
          if git diff --staged --quiet; then
            echo "å†…å®¹æœªå‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            git commit -m "è‡ªåŠ¨æ›´æ–°è®¢é˜…: $(date +'%Y-%m-%d %H:%M')"
            # å› ä¸º checkout æ—¶ç”¨äº† PATï¼Œè¿™é‡Œç›´æ¥ push å³å¯
            git push origin HEAD:${{ github.ref_name }}
          fi

      - name: 5. å¼€å¯ Cloudflare è¿œç¨‹è°ƒè¯•éš§é“
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared

          ./cloudflared tunnel --url http://127.0.0.1:3001 --logfile tunnel.log &
          ./cloudflared tunnel --url http://127.0.0.1:3000 --logfile backend.log &
          
          sleep 10
          UI_URL=$(grep -o 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
          API_URL=$(grep -o 'https://[-0-9a-z]*\.trycloudflare\.com' backend.log | head -n 1)
          
          echo "========================================================="
          echo "âœ… è®¢é˜…æ–‡ä»¶åŒæ­¥æˆåŠŸï¼"
          echo "ğŸŒ å‰ç«¯ç½‘é¡µ (UI): $UI_URL"
          echo "ğŸ”— åç«¯æ¥å£ (API): $API_URL"
          echo "========================================================="
          
          echo "è™šæ‹Ÿæœºå°†åœ¨ 15 åˆ†é’Ÿåè‡ªåŠ¨å…³é—­ã€‚"
          sleep 900
