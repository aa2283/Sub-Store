name: Sub-Store Sync and Debug æµ‹è¯•

on:
  workflow_dispatch:

jobs:
  build-and-debug:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Launch Sub-Store
        run: |
          # åå°å¯åŠ¨å®¹å™¨
          docker run -d --name substore-svc \
            -p 3000:3000 \
            -p 3001:3001 \
            xream/sub-store
          echo "ç­‰å¾…å®¹å™¨å¯åŠ¨ (20s)..."
          sleep 20

      - name: Download and Save Subscriptions (å…ˆæ‰§è¡Œä¿å­˜)
        run: |
          # 1. åˆ›å»ºå…¨å°å†™çš„ subs ç›®å½•
          mkdir -p subs
          
          echo ">>> æ­£åœ¨æŠ“å– ClashMeta æ ¼å¼..."
          curl -s "http://127.0.0.1:3001/download/sub?target=ClashMeta" -o subs/all.yaml
          
          echo ">>> æ­£åœ¨æŠ“å– URI æ ¼å¼..."
          curl -s "http://127.0.0.1:3001/download/sub?target=URI" -o subs/all.txt
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŠ“å–æˆåŠŸï¼ˆé˜²æ­¢ç©ºæ–‡ä»¶ï¼‰
          ls -lh subs/

      - name: Git Push Changes
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add subs/
          git commit -m "è‡ªåŠ¨æ›´æ–°è®¢é˜…: $(date +'%Y-%m-%d %H:%M')" || exit 0
          git push

      - name: Setup Cloudflare Debug Tunnels (æœ€åå¼€å¯è°ƒè¯•)
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared

          # å¯åŠ¨å‰ç«¯éš§é“ (3001)
          ./cloudflared tunnel --url http://127.0.0.1:3001 --logfile tunnel.log &
          # å¯åŠ¨åç«¯éš§é“ (3000)
          ./cloudflared tunnel --url http://127.0.0.1:3000 --logfile backend.log &
          
          sleep 10
          UI_URL=$(grep -o 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
          API_URL=$(grep -o 'https://[-0-9a-z]*\.trycloudflare\.com' backend.log | head -n 1)
          
          echo "========================================================="
          echo "âœ… è‡ªåŠ¨åŒ–åŒæ­¥å·²å®Œæˆï¼æ–‡ä»¶å·²æ¨é€åˆ° GitHubã€‚"
          echo "---------------------------------------------------------"
          echo "ğŸŒ å‰ç«¯å…¥å£: $UI_URL"
          echo "ğŸ”— åç«¯ API: $API_URL"
          echo "ğŸ‘‰ æç¤º: è¿›å…¥å‰ç«¯åï¼Œè¯·åœ¨è®¾ç½®ä¸­å°†åç«¯åœ°å€æ”¹ä¸ºä¸Šé¢çš„ API é“¾æ¥ã€‚"
          echo "========================================================="
          
          # æ­¤å¤„ä¿æŒè¿è¡Œ 15 åˆ†é’Ÿä¾›ä½ æŸ¥çœ‹ï¼Œæ—¶é—´åˆ°åä¼šè‡ªåŠ¨ç»“æŸ
          echo "è°ƒè¯•æ¨¡å¼ä¿æŒ 15 åˆ†é’Ÿ..."
          sleep 900
