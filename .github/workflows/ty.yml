name: Sub-Store 独立同步与长效调试

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.MY_PAT }}

      - name: 2. 启动 Sub-Store 后端
        run: |
          mkdir -p sub-store-data
          docker run -d --name substore-svc \
            -v $(pwd)/sub-store-data:/opt/app/data \
            -p 3000:3000 -p 3001:3001 xream/sub-store
          sleep 20

      - name: 3. 【核心】开启长效隧道 (后台运行)
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared
          
          # 使用 nohup 确保隧道在后台运行，不会阻塞后续步骤
          nohup ./cloudflared tunnel --url http://127.0.0.1:3001 --logfile tunnel.log 2>&1 &
          nohup ./cloudflared tunnel --url http://127.0.0.1:3000 --logfile backend.log 2>&1 &
          
          sleep 15
          UI_URL=$(grep -o 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
          API_URL=$(grep -o 'https://[-0-9a-z]*\.trycloudflare\.com' backend.log | head -n 1)
          
          echo "========================================================="
          echo "🌐 调试 UI 地址: $UI_URL"
          echo "🔗 调试 API 地址: $API_URL"
          echo "⚠️ 注意：即便你关闭网页，后台同步仍会继续。"
          echo "========================================================="

      - name: 4. 执行自动同步任务
        run: |
          mkdir -p subs
          # 这里访问的是本地 127.0.0.1，完全不受外部隧道状态影响
          curl -s "http://127.0.0.1:3000/download/GitHub-Test?target=ClashMeta" -o subs/all.yaml
          curl -s "http://127.0.0.1:3000/download/GitHub-Test?target=URI" -o subs/all.txt
          ls -lh subs/

      - name: 5. 立即推送文件至仓库
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          git add subs/
          git commit -m "自动更新订阅: $(date +'%Y-%m-%d %H:%M')" || exit 0
          # 使用 MY_PAT 强制推送
          git push https://${{ secrets.MY_PAT }}@github.com/${{ github.repository }}.git HEAD:${{ github.ref_name }}

      - name: 6. 维持工作流运行 (挂机调试)
        run: |
          echo ">>> 同步已完成，现在进入挂机调试模式。"
          echo ">>> 你可以在未来的 1 小时内随时进入上面的 UI 链接修改配置。"
          # 保持虚拟机运行 60 分钟
          sleep 3600
