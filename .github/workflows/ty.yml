name: Sub-Store è‡ªåŠ¨åŒæ­¥ä¸è°ƒè¯•

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘è¿è¡Œ

jobs:
  build-and-debug:
    runs-on: ubuntu-latest
    steps:
      - name: 1. æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: 2. å¯åŠ¨ Sub-Store æœåŠ¡
        run: |
          # åå°å¯åŠ¨ Docker å®¹å™¨ï¼Œæ˜ å°„ 3000 å’Œ 3001 ç«¯å£
          docker run -d --name substore-svc \
            -p 3000:3000 \
            -p 3001:3001 \
            xream/sub-store
          echo "æ­£åœ¨ç­‰å¾…å®¹å™¨åˆå§‹åŒ– (20ç§’)..."
          sleep 20

      - name: 3. æŠ“å–è®¢é˜…å†…å®¹
        run: |
          # åˆ›å»ºå­˜æ”¾è®¢é˜…çš„å°å†™ç›®å½•
          mkdir -p subs
          
          echo ">>> æ­£åœ¨æŠ“å– ClashMeta æ ¼å¼..."
          curl -s "http://127.0.0.1:3001/download/sub?target=ClashMeta" -o subs/all.yaml
          
          echo ">>> æ­£åœ¨æŠ“å– URI æ ¼å¼..."
          curl -s "http://127.0.0.1:3001/download/sub?target=URI" -o subs/all.txt
          
          # ç»ˆç«¯æ˜¾ç¤ºæŠ“å–ç»“æœæ‘˜è¦
          ls -lh subs/

      - name: 4. æ¨é€æ›´æ–°åˆ° GitHub ä»“åº“
        env:
          # è°ƒç”¨æ‚¨åœ¨ Secrets ä¸­è®¾ç½®çš„ MY_PAT
          TOKEN: ${{ secrets.MY_PAT }}
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Action"
          
          # æ„é€ å¸¦ Token çš„è¿œç¨‹ä»“åº“åœ°å€ï¼Œç¡®ä¿æ‹¥æœ‰å†™å…¥æƒé™
          REMOTE_REPO="https://${TOKEN}@github.com/${{ github.repository }}.git"
          
          git add subs/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å†…å®¹å˜åŒ–ï¼Œé˜²æ­¢ç©º commit æŠ¥é”™
          if git diff --staged --quiet; then
            echo "å†…å®¹æœªå‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            git commit -m "è‡ªåŠ¨æ›´æ–°è®¢é˜…: $(date +'%Y-%m-%d %H:%M')"
            # æ¨é€åˆ°å½“å‰åˆ†æ”¯
            git push "${REMOTE_REPO}" HEAD:${{ github.ref_name }}
          fi

      - name: 5. å¼€å¯ Cloudflare è¿œç¨‹è°ƒè¯•éš§é“ (å¯é€‰)
        run: |
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
          chmod +x cloudflared

          # å¯åŠ¨åŒéš§é“æ˜ å°„ï¼šå‰ç«¯ 3001ï¼Œåç«¯ 3000
          ./cloudflared tunnel --url http://127.0.0.1:3001 --logfile tunnel.log &
          ./cloudflared tunnel --url http://127.0.0.1:3000 --logfile backend.log &
          
          sleep 10
          UI_URL=$(grep -o 'https://[-0-9a-z]*\.trycloudflare\.com' tunnel.log | head -n 1)
          API_URL=$(grep -o 'https://[-0-9a-z]*\.trycloudflare\.com' backend.log | head -n 1)
          
          echo "========================================================="
          echo "âœ… è®¢é˜…æ–‡ä»¶åŒæ­¥æˆåŠŸï¼å·²æ¨é€åˆ°ä»“åº“ subs/ æ–‡ä»¶å¤¹ã€‚"
          echo "---------------------------------------------------------"
          echo "ğŸŒ å‰ç«¯ç½‘é¡µ (UI): $UI_URL"
          echo "ğŸ”— åç«¯æ¥å£ (API): $API_URL"
          echo "ğŸ‘‰ æ“ä½œæç¤º: å¦‚æœéœ€è¦æ‰‹åŠ¨ä¿®æ”¹é…ç½®ï¼Œè¯·è¿›å…¥ç½‘é¡µåï¼Œ"
          echo "   åœ¨ã€è®¾ç½®ã€ä¸­å°†åç«¯åœ°å€ä¿®æ”¹ä¸ºä¸Šæ–¹çš„ API é“¾æ¥ã€‚"
          echo "========================================================="
          
          # ä¿æŒè¿è¡Œ 15 åˆ†é’Ÿï¼Œæ–¹ä¾¿ä½ è¿›å…¥ç½‘é¡µæŸ¥çœ‹æˆ–ä¿®æ”¹
          echo "è™šæ‹Ÿæœºå°†åœ¨ 15 åˆ†é’Ÿåè‡ªåŠ¨å…³é—­ã€‚"
          sleep 900
